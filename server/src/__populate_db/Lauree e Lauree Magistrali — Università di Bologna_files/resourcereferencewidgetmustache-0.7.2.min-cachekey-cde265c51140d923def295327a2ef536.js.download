
/* Merged Plone Javascript file
 * This file is dynamically assembled from separate parts.
 * Some of these parts have 3rd party licenses or copyright information attached
 * Such information is valid for that section,
 * not for the entire composite file
 * originating files are separated by - filename.js -
 */

/* - ++resource++referencewidget/mustache-0.7.2.min.js - */
// http://www.unibo.it/portal_javascripts/++resource++referencewidget/mustache-0.7.2.min.js?original=1
(function(root,factory){if(typeof exports==="object"&&exports){module.exports=factory}else if(typeof define==="function"&&define.amd){define(factory)}else{root.Mustache=factory}})(this,function(){var exports={};exports.name="mustache.js";exports.version="0.7.2";exports.tags=["{{","}}"];exports.Scanner=Scanner;exports.Context=Context;exports.Writer=Writer;var whiteRe=/\s*/;var spaceRe=/\s+/;var nonSpaceRe=/\S/;var eqRe=/\s*=/;var curlyRe=/\s*\}/;var tagRe=/#|\^|\/|>|\{|&|=|!/;function testRe(re,string){return RegExp.prototype.test.call(re,string)}function isWhitespace(string){return!testRe(nonSpaceRe,string)}var isArray=Array.isArray||function(obj){return Object.prototype.toString.call(obj)==="[object Array]"};function escapeRe(string){return string.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function escapeHtml(string){return String(string).replace(/[&<>"'\/]/g,function(s){return entityMap[s]})}exports.escape=escapeHtml;function Scanner(string){this.string=string;this.tail=string;this.pos=0}Scanner.prototype.eos=function(){return this.tail===""};Scanner.prototype.scan=function(re){var match=this.tail.match(re);if(match&&match.index===0){this.tail=this.tail.substring(match[0].length);this.pos+=match[0].length;return match[0]}return""};Scanner.prototype.scanUntil=function(re){var match,pos=this.tail.search(re);switch(pos){case-1:match=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:match="";break;default:match=this.tail.substring(0,pos);this.tail=this.tail.substring(pos);this.pos+=pos}return match};function Context(view,parent){this.view=view;this.parent=parent;this.clearCache()}Context.make=function(view){return view instanceof Context?view:new Context(view)};Context.prototype.clearCache=function(){this._cache={}};Context.prototype.push=function(view){return new Context(view,this)};Context.prototype.lookup=function(name){var value=this._cache[name];if(!value){if(name==="."){value=this.view}else{var context=this;while(context){if(name.indexOf(".")>0){var names=name.split("."),i=0;value=context.view;while(value&&i<names.length){value=value[names[i++]]}}else{value=context.view[name]}if(value!=null){break}context=context.parent}}this._cache[name]=value}if(typeof value==="function"){value=value.call(this.view)}return value};function Writer(){this.clearCache()}Writer.prototype.clearCache=function(){this._cache={};this._partialCache={}};Writer.prototype.compile=function(template,tags){var fn=this._cache[template];if(!fn){var tokens=exports.parse(template,tags);fn=this._cache[template]=this.compileTokens(tokens,template)}return fn};Writer.prototype.compilePartial=function(name,template,tags){var fn=this.compile(template,tags);this._partialCache[name]=fn;return fn};Writer.prototype.compileTokens=function(tokens,template){var fn=compileTokens(tokens);var self=this;return function(view,partials){if(partials){if(typeof partials==="function"){self._loadPartial=partials}else{for(var name in partials){self.compilePartial(name,partials[name])}}}return fn(self,Context.make(view),template)}};Writer.prototype.render=function(template,view,partials){return this.compile(template)(view,partials)};Writer.prototype._section=function(name,context,text,callback){var value=context.lookup(name);switch(typeof value){case"object":if(isArray(value)){var buffer="";for(var i=0,len=value.length;i<len;++i){buffer+=callback(this,context.push(value[i]))}return buffer}return value?callback(this,context.push(value)):"";case"function":var self=this;var scopedRender=function(template){return self.render(template,context)};var result=value.call(context.view,text,scopedRender);return result!=null?result:"";default:if(value){return callback(this,context)}}return""};Writer.prototype._inverted=function(name,context,callback){var value=context.lookup(name);if(!value||isArray(value)&&value.length===0){return callback(this,context)}return""};Writer.prototype._partial=function(name,context){if(!(name in this._partialCache)&&this._loadPartial){this.compilePartial(name,this._loadPartial(name))}var fn=this._partialCache[name];return fn?fn(context):""};Writer.prototype._name=function(name,context){var value=context.lookup(name);if(typeof value==="function"){value=value.call(context.view)}return value==null?"":String(value)};Writer.prototype._escaped=function(name,context){return exports.escape(this._name(name,context))};function compileTokens(tokens){var subRenders={};function subRender(i,tokens,template){if(!subRenders[i]){var fn=compileTokens(tokens);subRenders[i]=function(writer,context){return fn(writer,context,template)}}return subRenders[i]}return function(writer,context,template){var buffer="";var token,sectionText;for(var i=0,len=tokens.length;i<len;++i){token=tokens[i];switch(token[0]){case"#":sectionText=template.slice(token[3],token[5]);buffer+=writer._section(token[1],context,sectionText,subRender(i,token[4],template));break;case"^":buffer+=writer._inverted(token[1],context,subRender(i,token[4],template));break;case">":buffer+=writer._partial(token[1],context);break;case"&":buffer+=writer._name(token[1],context);break;case"name":buffer+=writer._escaped(token[1],context);break;case"text":buffer+=token[1];break}}return buffer}}function nestTokens(tokens){var tree=[];var collector=tree;var sections=[];var token;for(var i=0,len=tokens.length;i<len;++i){token=tokens[i];switch(token[0]){case"#":case"^":sections.push(token);collector.push(token);collector=token[4]=[];break;case"/":var section=sections.pop();section[5]=token[2];collector=sections.length>0?sections[sections.length-1][4]:tree;break;default:collector.push(token)}}return tree}function squashTokens(tokens){var squashedTokens=[];var token,lastToken;for(var i=0,len=tokens.length;i<len;++i){token=tokens[i];if(token[0]==="text"&&lastToken&&lastToken[0]==="text"){lastToken[1]+=token[1];lastToken[3]=token[3]}else{lastToken=token;squashedTokens.push(token)}}return squashedTokens}function escapeTags(tags){return[new RegExp(escapeRe(tags[0])+"\\s*"),new RegExp("\\s*"+escapeRe(tags[1]))]}exports.parse=function(template,tags){template=template||"";tags=tags||exports.tags;if(typeof tags==="string")tags=tags.split(spaceRe);if(tags.length!==2){throw new Error("Invalid tags: "+tags.join(", "))}var tagRes=escapeTags(tags);var scanner=new Scanner(template);var sections=[];var tokens=[];var spaces=[];var hasTag=false;var nonSpace=false;function stripSpace(){if(hasTag&&!nonSpace){while(spaces.length){tokens.splice(spaces.pop(),1)}}else{spaces=[]}hasTag=false;nonSpace=false}var start,type,value,chr;while(!scanner.eos()){start=scanner.pos;value=scanner.scanUntil(tagRes[0]);if(value){for(var i=0,len=value.length;i<len;++i){chr=value.charAt(i);if(isWhitespace(chr)){spaces.push(tokens.length)}else{nonSpace=true}tokens.push(["text",chr,start,start+1]);start+=1;if(chr==="\n"){stripSpace()}}}start=scanner.pos;if(!scanner.scan(tagRes[0])){break}hasTag=true;type=scanner.scan(tagRe)||"name";scanner.scan(whiteRe);if(type==="="){value=scanner.scanUntil(eqRe);scanner.scan(eqRe);scanner.scanUntil(tagRes[1])}else if(type==="{"){var closeRe=new RegExp("\\s*"+escapeRe("}"+tags[1]));value=scanner.scanUntil(closeRe);scanner.scan(curlyRe);scanner.scanUntil(tagRes[1]);type="&"}else{value=scanner.scanUntil(tagRes[1])}if(!scanner.scan(tagRes[1])){throw new Error("Unclosed tag at "+scanner.pos)}if(type==="/"){if(sections.length===0){throw new Error('Unopened section "'+value+'" at '+start)}var section=sections.pop();if(section[1]!==value){throw new Error('Unclosed section "'+section[1]+'" at '+start)}}var token=[type,value,start,scanner.pos];tokens.push(token);if(type==="#"||type==="^"){sections.push(token)}else if(type==="name"||type==="{"||type==="&"){nonSpace=true}else if(type==="="){tags=value.split(spaceRe);if(tags.length!==2){throw new Error("Invalid tags at "+start+":"+tags.join(","))}tagRes=escapeTags(tags)}}var section=sections.pop();if(section){throw new Error('Unclosed section "'+section[1]+'" at '+scanner.pos)}return nestTokens(squashTokens(tokens))};var _writer=new Writer;exports.clearCache=function(){return _writer.clearCache()};exports.compile=function(template,tags){return _writer.compile(template,tags)};exports.compilePartial=function(name,template,tags){return _writer.compilePartial(name,template,tags)};exports.compileTokens=function(tokens,template){return _writer.compileTokens(tokens,template)};exports.render=function(template,view,partials){return _writer.render(template,view,partials)};exports.to_html=function(template,view,partials,send){var result=exports.render(template,view,partials);if(typeof send==="function"){send(result)}else{return result}};return exports}());

/* - ++resource++bacheca.js - */
// http://www.unibo.it/portal_javascripts/++resource++bacheca.js?original=1
$(document).ready(function(){var fs_reference=$("#fieldset-0");var fs_news=$("#fieldset-1");var fs_event=$("#fieldset-2");var show_news=function(){fs_reference.hide();fs_event.hide();fs_news.show()};var show_event=function(){fs_reference.hide();fs_event.show();fs_news.show()};var show_reference=function(){fs_reference.show();fs_event.hide();fs_news.hide()};var toggle_fields_visibility=function(val){switch(val){case 'news':show_news();break;case 'event':show_event();break;case 'reference':show_reference();break;default:throw new Error(val+" is not a valid item type");break}};body=$('.template-unibo.bacheca.avviso');if(body==undefined){body=$('.portaltype-avviso')}
if(body){type_field=$('#form-widgets-item_type');if(type_field.length){toggle_fields_visibility(type_field.val());type_field.bind('change', function(){toggle_fields_visibility($(this).val())})}}
var nav_selector='#bacheca-navigation';var link_selector=nav_selector+' a';var link=$(link_selector);link.bind('click', function(evt){evt.preventDefault();$('#u-spinner').show();$.ajax({url:$(this).attr('href'),data:{'ajax_load':'true'},context:document.body,success: function(data){data=$(data);var avvisi=data.find('.avviso-pair');for(var i=0;i<avvisi.length;i++){$('.avviso-pair').filter(':last').after(avvisi[i])}
new_link=data.find(link_selector);if(new_link.length)
link.attr('href',new_link.attr('href'));else
$(nav_selector).hide();$('#u-spinner').hide()}})})});

/* - ++resource++unibo.didattica/didattica.js - */
// http://www.unibo.it/portal_javascripts/++resource++unibo.didattica/didattica.js?original=1
(function($){if((typeof window.unibo)==="undefined")
window.unibo={};var unibo=window.unibo;unibo.didattica={};var didattica=window.unibo.didattica;didattica._getUrlVars=function(url){var vars={};var parts=url.replace(/[?&]+([^=&]+)=([^&]*)/gi,
function(m,key,value){vars[key]=value});return vars};$(document).delegate(".asyncload","click", function(e){var url=$(this).attr('href'),fragment=$(this).data('fragment');history.pushState({},'',url);if(url.indexOf('?')>0){url=url+'&ajax_load=1'}
else{url=url+'?ajax_load=1'}
e.preventDefault();$(fragment).css({position:'relative'});$(fragment).uniboSpinner("show",{template:'#u-didattica-spinner'});$(fragment).load(url+" "+fragment,
function(responseText,textStatus,XMLHttpRequest){$(fragment).uniboSpinner("hide");switch(XMLHttpRequest.status){case 200:break;case 404:$(fragment).html('<p>Looks like the results '+'have not been uploaded to the server yet. '+'Please check back later.</p>');break;default:$(fragment).html('<p>'+XMLHttpRequest.status+': '+XMLHttpRequest.statusText+'. '+'Please contact the support '+'and let them know.</p>');break}})});didattica.resultToggle=function(el){var target=$(el).next();if($(el).hasClass("plus")){target.hide();target.showAccessible();target.slideDown('slow')}
else{target.slideUp('slow', function(){target.hideAccessible();target.show()})}
$(el).toggleClass("plus");$(el).toggleClass("minus")};didattica.initListaCorsi=function(){$(".lowdown").hideAccessible();$(".output-list").addClass("plus");$(".output-list").removeClass("minus");$('#showFilters').click(function(){$('#filter-list').slideToggle('slow', function(){});$(this).toggleClass("plus");$(this).toggleClass("minus");return false});$(".plusminus-results .output-list, .plusminus-results .output-list-school").click(function(e){e.preventDefault();didattica.resultToggle(this)});$("#u-filter-container a, #filter-list a, #u-corsifilterbox a.remove-filter").click(function(e){e.preventDefault();didattica.refreshPage($(this).attr('href'))})};didattica.refreshPage=function(url){$('#u-content-main').uniboSpinner("show");$('#u-filter-container').uniboSpinner("show");$.ajax({url:url,type:'GET',dataType:"html",success: function(resp){$('#u-content-main').uniboSpinner("hide");$('#u-filter-container').uniboSpinner("hide");$('#u-content-foremost').html($('#u-content-foremost',resp).html());$('#u-filter-container').html($('#u-filter-container',resp).html());$('#search-coursename-box').html($('#search-coursename-box',resp).html());didattica.initListaCorsi();var hasFilters=false;var parms=didattica._getUrlVars(url);for(var key in parms){if(key in{descrizioneCorso:1,codiceScuola:1,codiceTipoCorso:1,codicePolo:1,intconmul:1}){hasFilters=true}}
if(!hasFilters){$('.plusminus-results .output-list-school').addClass('plus');$('.plusminus-results .output-list-school').removeClass('minus');$('.plusminus-results .school-courses').hideAccessible()}
if(url.indexOf("codiceScuola=")==-1){$('#filter-school').hide();$('#filter-school-trigger').toggleClass("minus");$('#filter-school-trigger').toggleClass("plus")}
$("input[name='corsiper']").click(yearSearchEnable);yearSearchEnable();if(typeof scanforlinks!="undefined"){$(scanforlinks)}}});return false};$.fn.hideAccessible=function(){this.css({position:'absolute',left:'-1000em',top:'-1000em'})};$.fn.showAccessible=function(){this.css('position','static')};
function yearSearchEnable(){var ddlYear=jq("select#anno-accademico");if(jq("input[name='corsiper']:checked").val()=='iscritti')
ddlYear.attr('disabled',false);else
ddlYear.attr('disabled',true)}
$(document).ready(function(){$(document).delegate("body.portaltype-listacorsi a.umtrack","click", function(){if(typeof pageTracker!='undefined'){pageTracker._trackEvent('Sitocorso','Clic',$(this).data('title'))}});if($('body.portaltype-listacorsi').length>0){didattica.initListaCorsi();$(document).delegate('#filter-school-trigger','click', function(){$('#filter-school').slideToggle('slow');$('#filter-school-trigger').toggleClass("minus");$('#filter-school-trigger').toggleClass("plus");event.preventDefault()});var url=document.location.href;var hasFilters=false;var parms=didattica._getUrlVars(url);for(var key in parms){if(key in{descrizioneCorso:1,codiceScuola:1,codiceTipoCorso:1,codicePolo:1,intconmul:1}){hasFilters=true}}
if(!hasFilters){$('.plusminus-results .output-list-school').addClass('plus');$('.plusminus-results .output-list-school').removeClass('minus');$('.plusminus-results .school-courses').hideAccessible()}
if(url.indexOf("codiceScuola=")==-1){$('#filter-school').hide();$('#filter-school-trigger').toggleClass("minus");$('#filter-school-trigger').toggleClass("plus")}
$("input[name='corsiper']").click(yearSearchEnable);yearSearchEnable()}})})(jQuery);

/* - ++resource++unibo.shelf/ICanHaz.min.js - */
(function(){var p,t=Object.prototype.toString;Array.isArray=Array.isArray||function(a){return"[object Array]"==t.call(a)};var q=String.prototype.trim,g;if(q)g=function(a){return null==a?"":q.call(a)};else{var h,m;/\S/.test("\u00a0")?(h=/^[\s\xA0]+/,m=/[\s\xA0]+$/):(h=/^\s+/,m=/\s+$/);g=function(a){return null==a?"":a.toString().replace(h,"").replace(m,"")}}var u={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},r={},s=function(){};s.prototype={otag:"{{",ctag:"}}",pragmas:{},buffer:[],pragmas_implemented:{"IMPLICIT-ITERATOR":!0},
context:{},render:function(a,b,c,d){d||(this.context=b,this.buffer=[]);if(this.includes("",a)){a=this.render_pragmas(a);var e=this.render_section(a,b,c);!1===e&&(e=this.render_tags(a,b,c,d));if(d)return e;this.sendLines(e)}else{if(d)return a;this.send(a)}},send:function(a){""!==a&&this.buffer.push(a)},sendLines:function(a){if(a){a=a.split("\n");for(var b=0;b<a.length;b++)this.send(a[b])}},render_pragmas:function(a){if(!this.includes("%",a))return a;var b=this,c=this.getCachedRegex("render_pragmas",
function(a,b){return RegExp(a+"%([\\w-]+) ?([\\w]+=[\\w]+)?"+b,"g")});return a.replace(c,function(a,c,j){if(!b.pragmas_implemented[c])throw{message:"This implementation of mustache doesn't understand the '"+c+"' pragma"};b.pragmas[c]={};j&&(a=j.split("="),b.pragmas[c][a[0]]=a[1]);return""})},render_partial:function(a,b,c){a=g(a);if(!c||void 0===c[a])throw{message:"unknown_partial '"+a+"'"};return!b||"object"!=typeof b[a]?this.render(c[a],b,c,!0):this.render(c[a],b[a],c,!0)},render_section:function(a,
b,c){if(!this.includes("#",a)&&!this.includes("^",a))return!1;var d=this,e=this.getCachedRegex("render_section",function(a,b){return RegExp("^([\\s\\S]*?)"+a+"(\\^|\\#)\\s*(.+)\\s*"+b+"\n*([\\s\\S]*?)"+a+"\\/\\s*\\3\\s*"+b+"\\s*([\\s\\S]*)$","g")});return a.replace(e,function(a,e,g,f,k,l){a=e?d.render_tags(e,b,c,!0):"";l=l?d.render(l,b,c,!0):"";var n;f=d.find(f,b);"^"===g?n=!f||Array.isArray(f)&&0===f.length?d.render(k,b,c,!0):"":"#"===g&&(n=Array.isArray(f)?d.map(f,function(a){return d.render(k,
d.create_context(a),c,!0)}).join(""):d.is_object(f)?d.render(k,d.create_context(f),c,!0):"function"==typeof f?f.call(b,k,function(a){return d.render(a,b,c,!0)}):f?d.render(k,b,c,!0):"");return a+n+l})},render_tags:function(a,b,c,d){var e=this,j=function(){return e.getCachedRegex("render_tags",function(a,b){return RegExp(a+"(=|!|>|&|\\{|%)?([^#\\^]+?)\\1?"+b+"+","g")})},g=j(),h=function(a,d,f){switch(d){case "!":return"";case "=":return e.set_delimiters(f),g=j(),"";case ">":return e.render_partial(f,
b,c);case "{":case "&":return e.find(f,b);default:return a=e.find(f,b),String(a).replace(/&(?!\w+;)|[<>"']/g,function(a){return u[a]||a})}};a=a.split("\n");for(var f=0;f<a.length;f++)a[f]=a[f].replace(g,h,this),d||this.send(a[f]);if(d)return a.join("\n")},set_delimiters:function(a){a=a.split(" ");this.otag=this.escape_regex(a[0]);this.ctag=this.escape_regex(a[1])},escape_regex:function(a){arguments.callee.sRE||(arguments.callee.sRE=RegExp("(\\/|\\.|\\*|\\+|\\?|\\||\\(|\\)|\\[|\\]|\\{|\\}|\\\\)","g"));
return a.replace(arguments.callee.sRE,"\\$1")},find:function(a,b){a=g(a);var c;if(a.match(/([a-z_]+)\./ig)){var d=this.walk_context(a,b);(!1===d||0===d||d)&&(c=d)}else!1===b[a]||0===b[a]||b[a]?c=b[a]:(!1===this.context[a]||0===this.context[a]||this.context[a])&&(c=this.context[a]);return"function"==typeof c?c.apply(b):void 0!==c?c:""},walk_context:function(a,b){for(var c=a.split("."),d=void 0!=b[c[0]]?b:this.context,e=d[c.shift()];void 0!=e&&0<c.length;)d=e,e=e[c.shift()];return"function"==typeof e?
e.apply(d):e},includes:function(a,b){return-1!=b.indexOf(this.otag+a)},create_context:function(a){if(this.is_object(a))return a;var b=".";this.pragmas["IMPLICIT-ITERATOR"]&&(b=this.pragmas["IMPLICIT-ITERATOR"].iterator);var c={};c[b]=a;return c},is_object:function(a){return a&&"object"==typeof a},map:function(a,b){if("function"==typeof a.map)return a.map(b);for(var c=[],d=a.length,e=0;e<d;e++)c.push(b(a[e]));return c},getCachedRegex:function(a,b){var c=r[this.otag];c||(c=r[this.otag]={});var d=c[this.ctag];
d||(d=c[this.ctag]={});(c=d[a])||(c=d[a]=b(this.otag,this.ctag));return c}};p={name:"mustache.js",version:"0.4.0",to_html:function(a,b,c,d){var e=new s;d&&(e.send=d);e.render(a,b||{},c);if(!d)return e.buffer.join("\n")}};(function(){var a={VERSION:"0.10.2",templates:{},$:"undefined"!==typeof window?window.jQuery||window.Zepto||null:null,addTemplate:function(b,c){if("object"===typeof b)for(var d in b)this.addTemplate(d,b[d]);else a[b]?console.error("Invalid name: "+b+"."):a.templates[b]?console.error('Template "'+
b+'  " exists'):(a.templates[b]=c,a[b]=function(c,d){c=c||{};var g=p.to_html(a.templates[b],c,a.templates);return a.$&&!d?a.$(g):g})},clearAll:function(){for(var b in a.templates)delete a[b];a.templates={}},refresh:function(){a.clearAll();a.grabTemplates()},grabTemplates:function(){var b,c,d=document.getElementsByTagName("script"),e,g=[];b=0;for(c=d.length;b<c;b++)if((e=d[b])&&e.innerHTML&&e.id&&("text/html"===e.type||"text/x-icanhaz"===e.type))a.addTemplate(e.id,"".trim?e.innerHTML.trim():e.innerHTML.replace(/^\s+/,
"").replace(/\s+$/,"")),g.unshift(e);b=0;for(c=g.length;b<c;b++)g[b].parentNode.removeChild(g[b])}};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=a),exports.ich=a):this.ich=a;"undefined"!==typeof document&&(a.$?a.$(function(){a.grabTemplates()}):document.addEventListener("DOMContentLoaded",function(){a.grabTemplates()},!0))})()})();


/* - ++resource++unibo.shelf/unibo.shelf.js - */
// http://www.unibo.it/portal_javascripts/++resource++unibo.shelf/unibo.shelf.js?original=1
(function($){var unibo=window.unibo;if((typeof unibo)==="undefined")
throw new Error("'window.unibo' is undefined: "+"you must load 'unibo.base.js' before this file.");unibo.ShelfSchemaError=function(shelf,message,data){this.shelf=shelf;this.message=message;this.data=data};unibo.ShelfIndex=function(n){var length,i,l;this.WORD_LENGTH=30;if(n===0)
length=1;else
length=Math.ceil((n+1)/this.WORD_LENGTH);if((n%this.WORD_LENGTH)===0){this.words=[1];for(i=0,l=length-1;i<l;i++) this.words.push(0)}
else{this.words=[Math.pow(2,n-(this.WORD_LENGTH*(length-1)))];for(i=0,l=length-1;i<l;i++) this.words.push(0)}};unibo.ShelfIndex.prototype={copy: function(){var new_index=new unibo.ShelfIndex(1);new_index.words=[];for(var i=0,l=this.words.length;i<l;i++)
new_index.words.push(this.words[i]);return new_index},eq: function(other){var i,l,difference,one,two;if(other.words.length>=this.words.length){one=other;two=this}
else{one=this;two=other}
difference=one.words.length-two.words.length;for(i=0;i<difference;i++){if(one.words[i]!==0) return false}
for(i=0,l=two.words.length;i<l;i++){if(one.words[i+difference]!==two.words[i])
return false}
return true},_op: function(other,op){var i,l=Math.max(other.words.length,this.words.length),this_words=[],other_words=[];for(i=0;i<l;i++){if(i<(l-this.words.length))
this_words.push(0);else
this_words.push(this.words[i-(l-this.words.length)]);if(i<(l-other.words.length))
other_words.push(0);else
other_words.push(other.words[i-(l-other.words.length)]);if(op==="and")
this_words[i]=this_words[i]&other_words[i];else
this_words[i]=this_words[i]|other_words[i]}
this.words=this_words},s_and: function(other){this._op(other,"and")},s_or: function(other){this._op(other,"or")},has: function(number){number=new unibo.ShelfIndex(number);compare=number.copy();number.s_and(this);return number.eq(compare)},length: function(){var count=0;for(var i=0,l=this.words.length;i<l;i++){var c;var word_null=this.words[i];for(c=0;word_null;c++)
word_null=word_null&(word_null-1);count+=c}
return count}};unibo.shelf_zero_index=function(length){var index=new unibo.ShelfIndex(length);for(var i=0,l=index.words.length;i<l;i++)
index.words[i]=0;return index};unibo.shelf_full_index=function(length){var index=new unibo.ShelfIndex(length);for(var i=0,l=index.words.length;i<l;i++){index.words[i]=Math.pow(2,index.WORD_LENGTH)-1}
return index};unibo.ShelfSchemaError.prototype={toString: function(){return "ShelfSchemaError: "+unibo.format(this.message,this.data)}};unibo.Shelf=function(element,options){ich.grabTemplates();this.root=$(element);this.schema=options.schema;this.options={hash_prefix:'!/filter?',prefix:'u-shelf-',tag_separator:':',value_separator:':',item_tag:'item',attribute_tag:'attr',value_tag:'val',spinner:'#u-spinner',reset_filter_selector:'filter-cancel',numfound_selector:'numfound',converters:{'string': function(v){return unibo.trim(v)},'boolean': function(v){var value=false;switch(unibo.trim(v).toLowerCase()){case 'true':value=true;break;case '1':value=true;break;case 'on':value=true;break;default:break}
return value},'date': function(v){return new Date(v)},'datetime': function(v){return new Date(v)},'time': function(v){var t=v.split(":");return [parseInt(t[0],10),parseInt(t[1],10),parseInt(t[2],10)]},'integer': function(v){return parseInt(unibo.trim(v),10)},'float': function(v){return parseFloat(unibo.trim(v))}}};$.extend(this.options,options);this.elements=[];this.indexes={};this.selection={};this.value_titles={};this.spinner=$(this.options.spinner);if(this.options.nav)
this.nav=$(this.options.nav);else
this.nav=null;this.reset_filter_selector='.'+this.options.prefix+this.options.reset_filter_selector;this.numfound_selector='#'+this.options.prefix+this.options.numfound_selector;for(var attribute in this.schema){this.indexes[attribute]={}}};unibo.Shelf.prototype={index: function(i,data){var index=null;var key=null;var values=null;for(var attribute in data){index=this.indexes[attribute];schema=this.schema[attribute];values=data[attribute];if(values===null){continue}
if(!schema.multiple){values=[values]}
for(var j=0,l=values.length;j<l;j++){key=values[j].toString();if((typeof index[key])==="undefined")
index[key]=unibo.shelf_zero_index(this.elements.length);index[key].s_or(new unibo.ShelfIndex(i))}}},search: function(extra_selection){var selections={};$.extend(true,selections,this.selection);for(var attribute in extra_selection){if(!this.schema[attribute].multiple_choice||(typeof selections[attribute])==="undefined")
selections[attribute]={};for(var m=0,n=extra_selection[attribute].length;m<n;m++)
selections[attribute][extra_selection[attribute][m]]=true}
var found=unibo.shelf_full_index(this.elements.length);for(var key in selections){var index_values=unibo.shelf_zero_index(this.elements.length);for(var value in selections[key]){if((typeof this.indexes[key][value])!=="undefined")
index_values.s_or(this.indexes[key][value])}
found.s_and(index_values)}
return found},set_selection: function(){var selection_hash=[];for(var name in this.selection){for(var value in this.selection[name]){if(this.selection[name][value])
selection_hash.push(name+'="'+value+'"')}}
if(selection_hash.length>0)
window.location.hash=this.options.hash_prefix+encodeURI(selection_hash.join('&'));else
window.location.hash='!'},log: function(level,info){if((typeof window.console)!=="undefined")
window.console.log(level.toUpperCase()+": "+info)},get_selection: function(){var i,l,result;this.selection={};if(window.location.hash.length<=this.options.hash_prefix.length)
return;var hash=window.location.hash.substring(this.options.hash_prefix.length+1);if(hash.length===0)
return;hash=decodeURI(hash);var hash_elements_raw=hash.split('&');var hash_elements=[];for(i=0,l=hash_elements_raw.length;i<l;i++){if(/[A-Za-z0-9_]+=/.test(hash_elements_raw[i]))
hash_elements.push(hash_elements_raw[i]);else{if(hash_elements.length>0)
hash_elements[hash_elements.length-1]+='&'+hash_elements_raw[i];else{this.log("warning","Malformed hash '"+hash+"', bailing out.");return}}}
for(i=0,l=hash_elements.length;i<l;i++){result=/^([A-Za-z0-9_]+)="(.+)"$/.exec(hash_elements[i]);if(!result){this.log("warning","Malformed hash filter '"+hash_elements[i]+"', skipping.")}
else{if((typeof this.selection[result[1]])==="undefined")
this.selection[result[1]]={};this.selection[result[1]][result[2]]=true}}},render: function(){var self=this;this.spinner.show();if(this.nav){var ctx={filters:[]};this.nav.empty();for(var attribute in this.schema){var filter={title:this.schema[attribute].title,remove_filter_label:reset_filter_message,name:attribute,has_reset_filter_selector:false,hack_display:'display: none;',values:[]},titles=this.value_titles[attribute],counter=0,options=[],option,i,l;if(typeof(this.schema[attribute].values!=="undefined")){var ao=this.schema[attribute].values;for(i=0,l=ao.length;i<l;i++){if((typeof this.indexes[attribute][ao[i]])!=="undefined"){options.push(ao[i])}}
for(option in this.indexes[attribute]){if($.inArray(option,options)<0)
options.push(option)}}
else{for(option in this.indexes[attribute]){options.push(option)}}
for(i=0,l=options.length;i<l;i++){option=options[i];var name=this.nav.attr('id')+'-'+attribute,id=name+'-'+counter;var title=null;var option_html=null;var checked=false;counter++;if((typeof titles[option])!=="undefined")
title=titles[option];else
title=option;var extra_selection={};extra_selection[attribute]=[option];var result_index=this.search(extra_selection);if(((typeof this.selection[attribute])!=="undefined")&&((typeof this.selection[attribute][option])!=="undefined"))
checked=true;filter.hack_display='display: block;';filter.has_reset_filter_selector=(filter.has_reset_filter_selector||checked);filter.values.push({title:title,not_checked:(!checked),length:result_index.length(),klass:(result_index.length()===0?'disabled':'enabled')+(checked?' checked':''),multiple:this.schema[attribute].multiple_choice,not_multiple:(!this.schema[attribute].multiple_choice),name:name,value:option,id:id,checked:checked})}
ctx.filters.push(filter)}
this.nav.append(ich.shelf_form(ctx));this.nav.find(this.reset_filter_selector).click(function(e){e.preventDefault();self.reset($(this).attr('data-attribute-name'))});this.nav.find('.enabled input[type="checkbox"], '+'.enabled input[type="radio"]').
change(function(){self.selection={};self.nav.find('.enabled input[type="checkbox"], '+'.enabled input[type="radio"]').
filter(':checked').each(function(){var el=$(this);var attribute=el.attr('name').substring(self.nav.attr('id').length+1,el.attr('name').length);if(!self.schema[attribute].multiple_choice||(typeof self.selection[attribute])==="undefined")
self.selection[attribute]={};self.selection[attribute][el.attr('value')]=true});self.render()})}
var result=this.search({});var found_items=0;var all_items=this.root.find(this.class_of('item'));for(var item_index=0,n_items=this.elements.length;item_index<n_items;item_index++){if(result.has(item_index)){all_items.slice(item_index,item_index+1).show();found_items++}
else{all_items.slice(item_index,item_index+1).hide()}}
if(found_items>0){this.root.find(this.options.no_results).hide()}
else{this.root.find(this.options.no_results).show()}
var filters=[];for(var attribute_ in this.selection){var titles_=this.value_titles[attribute_];var values_=[];for(var value_ in this.selection[attribute_]){if((typeof titles_[value_])!=="undefined")
values_.push({title:titles_[value_],not_last:true});else
values_.push({title:value_,not_last:true})}
values_[values_.length-1].not_last=false;filters.push({name:attribute_,title:this.schema[attribute_].title,values:values_})}
$(this.options.filters_selector).empty();$(this.options.filters_selector).append(ich.shelf_filters({filters:filters}));$(this.options.filters_selector).
find(this.reset_filter_selector).click(function(e){e.preventDefault();self.reset($(this).attr('data-attribute-name'))});var nf=ich.shelf_numfound({found:found_items,total:this.elements.length,all:(this.elements.length==found_items)});$(this.numfound_selector).empty();$(this.numfound_selector).append(nf);this.set_selection();this.spinner.hide()},class_of: function(element,suffix){var result=this.options.prefix+this.options[element+'_tag'];if((typeof suffix)!=="undefined")
result+=this.options.tag_separator+suffix;return '*[class*="'+result+'"]'},extract: function(name,schema,attributes){var self=this;var values=[];var value_class=this.options.prefix+this.options.value_tag;attributes.each(function(){var classes=$(this).attr('class');var value=null;var value_title=null;if((typeof self.value_titles[name])==="undefined")
self.value_titles[name]={};var titles=self.value_titles[name];if(classes){classes=classes.split(" ");for(var i=0,l=classes.length;i<l;i++){if(classes[i].indexOf(value_class)===0)
value=classes[i].substring(value_class.length+self.options.value_separator.length,classes[i].length)}}
var title=$(this).text();if(value===null)
value=title;var converter=self.options.converters[schema.type];if((typeof schema.converter)!=="undefined")
converter=schema.converter;value=converter(value);values.push(value);value_title=function(value,title){return self.options.converters['string'](title)};switch(typeof schema.value_title){case "function":value_title=schema.value_title;break;case "object":value_title=function(value,title){return schema.value_title[value]};break;default:break}
titles[value.toString()]=value_title(value,title)});if(!schema.multiple)
return values[0];else
return values},parse: function(){var self=this;this.root.find(this.class_of('item')).each(function(i){var data={};for(var attribute in self.schema){var attributes=$(this).find(self.class_of('attribute',attribute));switch(attributes.length){case 0:{data[attribute]=null;break}
case 1:{data[attribute]=self.extract(attribute,self.schema[attribute],attributes.first());break}
default:{if(!self.schema[attribute].multiple)
throw new unibo.ShelfSchemaError(self,"unexpected multiple values for {attr}",{attr:attribute,values:attributes});data[attribute]=self.extract(attribute,self.schema[attribute],attributes);break}}}
self.elements.push(data)});$.each(self.elements, function(i){self.index(i,this)})},reset: function(attribute){delete this.selection[attribute];this.render()},load: function(){this.parse();this.get_selection();this.render()}};unibo.shelves=[];$.fn.uniboShelf=function(){var args=Array.prototype.slice.apply(arguments,[]);return this.each(function(){var element=$(this);var shelf=element.data('unibo.Shelf');if(!shelf){shelf=new unibo.Shelf(this,args[0]);element.data('unibo.Shelf',shelf);unibo.shelves.push(shelf);shelf.load()}
else{if(args.length>0)
shelf[args[0]].apply(shelf,args.slice(1))}})};$(document).ready(function(){$('div.u-shelf-item > h4 > a').click(function(e){e.preventDefault();$(this).parent().next('div').toggle();$(this).toggleClass('minus');$(this).toggleClass('plus')});$('#u-filter-display').click(function(e){e.preventDefault();$('#u-shelf-filter-list').toggle();$(this).toggleClass('minus');$(this).toggleClass('plus')})})})(jQuery);
